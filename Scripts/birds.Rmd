---
title: "bird_data"
author: "JL"
date: "`r Sys.Date()`"
output: html_document
---
_to do:_



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here) 
library(tidyverse)
library(janitor)
```

_Traits we discussed:_
nest type (ground, open-cup, cavity), nest location (ground, mid-canopy, canopy), foraging height (ground, mid-canopy, canopy), horizontal foraging strategy (ground, edge, core), diet (herbivore, invertivore, omnivore), morphological attributes (body mass, wing length, bill size), and migratory behaviour (resident/short-distance migrants, long-distance migrants)
Plus: Range size, population estimate, nest type, specialization to habitat, migration

```{r read in bc bird list}
birdlist <- read.csv(here("Data", "BirdLists", "bc_birds_checklist.csv"))
#test <- read.csv(here("Data", "BirdLists", "bc_birds_avibase_clements_2025.csv"))
birdlist <- birdlist%>%
  filter(if_any(everything(), ~ . != "" & !is.na(.)))
#duplicated(birdlist$common_name)#no duplicated, 567 birds

#setdiff(birdlist$sci_name, test$sci_name)

```

```{r read in trait data base available databases}
dtrait <- read.csv(here("Data", "TraitDatabases", "Dubovyk_trait_database.csv")) #> nest <- dtrait %>% select(name, eng_name, nest, nsbank, nsgroun, nsgrass, nsclif, nsbuild, nsshru, nsdeci, nsconi, nssnag, nsfloat, nscact, nstang, ntree, nesting.location)

dtrait <- dtrait %>% 
  mutate(ntree = nsdeci+nsconi,
         nest.tree.use = (ntree+nssnag)/100, #to what scale do they use trees to nest? Essentially adding the % they use deciduous, coniferous, and snags
         live_tree_nesting_use = ntree/100,
         snag_nesting_use = nssnag/100) %>% 
  select(name, synonyms, proj_id, et_id, synonyms, mlife, matage,nest, nsbank, nsgroun, nsgrass, nsclif, nsbuild, nsshru, nssnag, nscact, nstang, nsfloat, ntree, attem, eng_name,nest.tree.use, live_tree_nesting_use, snag_nesting_use) %>% 
  rename(Elton_ID = et_id,lifespan = mlife, ReproAge = matage,  nest.type = nest, clutches.per.year = attem,
         bank = nsbank, ground = nsgroun, grass = nsgrass, cliff = nsclif, human.structure = nsbuild, shrub = nsshru, snag = nssnag, float = nsfloat, cactus = nscact, tangle = nstang, tree = ntree)

#correcting some taxonony
dtrait$synonyms[dtrait$name=="Bubulcus ibis"] <- "Ardea ibis"
dtrait$synonyms[dtrait$name=="Accipiter cooperii"] <- "Astur cooperii"
dtrait$synonyms[dtrait$name=="Hylatomus pileatus"] <- "Dryocopus pileatus"
dtrait$synonyms[dtrait$synonyms=="Anas penelope"] <- "Mareca penelope"
dtrait$synonyms[dtrait$name=="Melanitta fusca"] <- "Melanitta deglandi"
dtrait$synonyms[dtrait$name=="Dendragapus canadensis"] <- "Canachites canadensis"
dtrait$synonyms[dtrait$name=="Larus argentatus"] <- "Larus smithsonianus"
dtrait$synonyms[dtrait$name=="Nannopterum auritus"] <- "Nannopterum auritum"
dtrait$synonyms[dtrait$proj_id==3070] <- "Tyto furcata"
dtrait$Elton_ID[dtrait$proj_id==4680] <- 9750 #this one doesnt have its elton id for some reason..
dtrait$synonyms[dtrait$proj_id==2920] <- "Astur atricapillus"
dtrait$synonyms[dtrait$proj_id==2180] <- "Larus brachyrhynchus"
dtrait$synonyms[dtrait$proj_id=="5240"] <- "NA"
dtrait$eng_name[dtrait$proj_id==3255] <- "White-winged Parakeet"
dtrait$name[dtrait$proj_id==3255] <- "Brotogeris versicolurus"

#making the nest category more broad:
#gourd, sphere, pendant, saucer, chamber, oven, cup --> MAKE ALL THE SAME... will be similarly affected to cups. VS TREE CAVITY; rockCREVICE/crack; burrow (+/-?) ; open[no, scrape--> combined these into one category] platform[negatively affected]  (tree; burrows; crevice[look at definition]) VS exposed 
dtrait <- dtrait %>% 
  mutate(nest.category = if_else(nest.type == "cup"|nest.type == "gourd"|nest.type == "sphere"|nest.type == "gourd"|nest.type == "saucer"|nest.type == "chamber"|nest.type == "oven"|nest.type == "pend", "built.structure", if_else(nest.type == "scrape"|nest.type == "no", "open", nest.type)))


#get nesting substrates
cols_to_check <- c("bank", "ground", "grass", 'cliff', 'human.structure', "shrub", "float", "snag", 'cactus', "tangle", "tree")
dtrait <- dtrait %>%
    mutate(majority.nesting.location = if_else(ground>51, "ground", if_else(grass>51, "grass", if_else(shrub>51, "shrub", if_else(tree>51, "tree", if_else(snag>51, "snag", if_else(bank>51, "bank", if_else(cliff>51, "cliff", if_else(human.structure>51, "human.structure", if_else(tangle>51, "tangle", if_else(float>51, "float", NA))))))))))) %>%
  rowwise() %>%
  mutate(
    row_values = list(c_across(all_of(cols_to_check))),
    sorted_indices = list(order(row_values, decreasing = TRUE)),
    most.common.nesting.location = cols_to_check[sorted_indices[1]],
    second.nesting.location = ifelse(
      # Condition: Is the second highest value equal to 0?
      row_values[sorted_indices[2]] == 0,
      # If TRUE: Assign NA (must be type character to match column names)
      NA_character_, 
      # If FALSE: Assign the column name
      cols_to_check[sorted_indices[2]])) %>% 
    ungroup() %>%
  select(-c(row_values, sorted_indices, bank, ground, grass, cliff, human.structure, shrub, float, snag, cactus, tangle, tree)) %>%
  ungroup()
###########################################################################################

#Ecology data paper - ELTON TRAITS
eco_t <- read.delim(here("Data", "TraitDatabases", "Ecology_BirdFuncDat.txt"), sep = "\t", header = T)
eco_t <- eco_t %>% 
  mutate(ForStrat.water = ForStrat.watbelowsurf+ForStrat.wataroundsurf) %>% 
  select(SpecID, Scientific, English, starts_with("ForStrat"), -c(ForStrat.Source, ForStrat.SpecLevel, ForStrat.EnteredBy, ForStrat.watbelowsurf, ForStrat.wataroundsurf)) %>% 
  rename(Elton_ID = SpecID, eng_name = English) %>% 
  filter(!is.na(Elton_ID))
eco_t$Scientific[eco_t$Elton_ID=="9750"] <- "Troglodytes hiemalis"

#get foraging strategy group:
cols_to_check <- eco_t %>% 
  select(starts_with("ForStrat")) %>% # Select the columns
  names()   
#cols_to_check <- c("ground", "understory", "midhigh", 'canopy', 'aerial', "water")

eco_t <- eco_t %>%
  mutate(majority.foraging.location = case_when(
      ForStrat.ground    > 51 ~ "ground",
      ForStrat.understory > 51 ~ "understory",
      ForStrat.midhigh   > 51 ~ "midhigh",
      ForStrat.canopy    > 51 ~ "canopy",
      ForStrat.aerial    > 51 ~ "aerial",
      ForStrat.water     > 51 ~ "water",
      TRUE ~ NA_character_)) %>%   
  rowwise() %>%
  mutate(
    row_values = list(c_across(all_of(cols_to_check))),
    sorted_indices = list(order(row_values, decreasing = TRUE)),
    most.common.foraging.location = cols_to_check[sorted_indices[1]],
    second.foraging.location = ifelse(
      # Condition: Is the second highest value equal to 0?
      row_values[sorted_indices[2]] == 0,
      # If TRUE: Assign NA (must be type character to match column names)
      NA_character_, 
      # If FALSE: Assign the column name
      cols_to_check[sorted_indices[2]])) %>% 
    ungroup() %>%
  select(-c(row_values, sorted_indices, ForStrat.ground, ForStrat.understory, ForStrat.midhigh, ForStrat.canopy, ForStrat.aerial, ForStrat.water))
eco_t$most.common.foraging.location <- gsub("ForStrat.", "", eco_t$most.common.foraging.location)
eco_t$second.foraging.location <- gsub("ForStrat.", "", eco_t$second.foraging.location)

#connect these based on the elton traits et_id
de.trait <- full_join(eco_t, dtrait, by = c("Elton_ID", "eng_name")) %>% 
   mutate(
    Scientific = coalesce(Scientific, name)  # use 'name' only if Scientific is NA
  )

  
#get bc birds
bctrait <- left_join(birdlist ,de.trait, by = c("sci_name" = "Scientific"))

unmatched <- bctrait %>%
  filter(is.na(Elton_ID)) %>%   # replace with a col you expect after join
  select(names(birdlist))
matched_by_common <- unmatched %>%
  left_join(de.trait, by = c("common_name" = "eng_name"))

bctrait <- bctrait %>%
  filter(!is.na(Elton_ID)) %>%  # keep the matched ones
  bind_rows(matched_by_common)

unmatched2 <- bctrait %>%
  filter(is.na(Elton_ID)) %>%   # replace with a col you expect after join
  select(names(birdlist))
matched_by_syn <- unmatched2 %>%
  left_join(de.trait, by = c("sci_name" = "synonyms"))

bctrait <- bctrait %>%
  filter(!is.na(Elton_ID)) %>%  # keep the matched ones
  bind_rows(matched_by_syn)



############################
#Avonet database
avtrait <- read.csv(here("Data", "TraitDatabases", "ELEData", "TraitData", "AVONET1_BirdLife.csv"))
avtrait3 <- read.csv(here("Data", "TraitDatabases", "ELEData", "TraitData", "AVONET3_BirdTree.csv"))

avtrait <- avtrait %>% 
  rename(sci_name = Species1,
         AV_ID = Sequence) %>% 
  select(AV_ID, sci_name, Mass, Habitat, Habitat.Density, Migration, Trophic.Level, Trophic.Niche, Primary.Lifestyle, Range.Size, Kipps.Distance, Hand.Wing.Index)

avtrait3 <- avtrait3 %>% 
  rename(sci_name = Species3) %>% 
  select(sci_name, Mass, Habitat, Habitat.Density, Migration, Trophic.Level, Trophic.Niche, Primary.Lifestyle, Range.Size, Kipps.Distance, Hand.Wing.Index)
#changing some of the codes to something more readable:
avtrait$Habitat.Density[avtrait$Habitat.Density == 1] <- "dense"
avtrait$Habitat.Density[avtrait$Habitat.Density == 2] <- "semiopen"
avtrait$Habitat.Density[avtrait$Habitat.Density == 3] <- "open"

avtrait$Migration[avtrait$Migration == 1] <- "sedentary"
avtrait$Migration[avtrait$Migration == 2] <- "partial"
avtrait$Migration[avtrait$Migration == 3] <- "migratory"

avtrait3$Habitat.Density[avtrait3$Habitat.Density == 1] <- "dense"
avtrait3$Habitat.Density[avtrait3$Habitat.Density == 2] <- "semiopen"
avtrait3$Habitat.Density[avtrait3$Habitat.Density == 3] <- "open"

avtrait3$Migration[avtrait3$Migration == 1] <- "sedentary"
avtrait3$Migration[avtrait3$Migration == 2] <- "partial"
avtrait3$Migration[avtrait3$Migration == 3] <- "migratory"

#fixing taxonomy - there arent many, so doing it by hand (and there are no common names to help out)
avtrait$sci_name[avtrait$sci_name=="Falcipennis canadensis"] <- "Canachites canadensis"
avtrait$sci_name[avtrait$sci_name=="Haematopus ater"] <- "Haematopus bachmani"
avtrait$sci_name[avtrait$sci_name=="Bubulcus ibis"] <- "Ardea ibis"
avtrait$sci_name[avtrait$sci_name=="Accipiter cooperii"] <- "Astur cooperii"
avtrait$sci_name[avtrait$sci_name=="Hylatomus pileatus"] <- "Dryocopus pileatus"
avtrait$sci_name[avtrait$sci_name=="Anas penelope"] <- "Mareca penelope"
#avtrait$sci_name[avtrait$sci_name=="Melanitta fusca"] <- "Melanitta deglandi"
#avtrait$sci_name[avtrait$sci_name=="Dendragapus canadensis"] <- "Canachites canadensis"
#avtrait$sci_name[avtrait$sci_name=="Larus argentatus"] <- "Larus smithsonianus"
avtrait$sci_name[avtrait$sci_name=="Nannopterum auritus"] <- "Nannopterum auritum"
avtrait$sci_name[avtrait$sci_name=="Tyto alba"] <- "Tyto furcata"
avtrait$sci_name[avtrait$sci_name=="Accipiter gentilis"] <- "Astur atricapillus"
avtrait$sci_name[avtrait$sci_name=="Steganopus tricolor"] <- "Phalaropus tricolor"
avtrait$sci_name[avtrait$sci_name=="Catharacta maccormicki"] <- "Stercorarius maccormicki"
avtrait$sci_name[avtrait$sci_name=="Larus philadelphia"] <- "Chroicocephalus philadelphia"
avtrait$sci_name[avtrait$sci_name=="Larus ridibundus"] <- "Chroicocephalus ridibundus"
avtrait$sci_name[avtrait$sci_name=="Larus atricilla"] <- "Leucophaeus atricilla"
avtrait$sci_name[avtrait$sci_name=="Larus argentatus"] <- "Larus vegae" ## these were all one species, double check this!
avtrait$sci_name[avtrait$sci_name=="Larus pipixcan"] <- "Leucophaeus pipixcan"
avtrait$sci_name[avtrait$sci_name=="Sula leucogaster"] <- "Sula brewsteri"
avtrait$sci_name[avtrait$sci_name=="Ixobrychus exilis"] <- "Botaurus exilis"
avtrait$sci_name[avtrait$sci_name=="Butorides striatus"] <- "Butorides virescens"
avtrait$sci_name[avtrait$sci_name=="Picoides tridactylus"] <- "Picoides dorsalis"
avtrait$sci_name[avtrait$sci_name=="Leuconotopicus villosus"] <- "Dryobates villosus" #some taxonomic disagreement it seems, sticking to this one
#avtrait$sci_name[avtrait$sci_name=="Charadrius mexicanus"] <- "Himantopus mexicanus" #this one not in avonet1
#avtrait$sci_name[avtrait$sci_name=="Butorides striatus"] <- "Butorides virescens" #this one not in avonet1
avtrait$sci_name[avtrait$sci_name=="Leuconotopicus albolarvatus"] <- "Dryobates albolarvatus"
avtrait$sci_name[avtrait$sci_name=="Regulus calendula"] <- "Corthylio calendula"
avtrait$sci_name[avtrait$sci_name=="Icterus galbula"] <- "Icterus bullockii"
avtrait$sci_name[avtrait$sci_name=="Anthus rubescens"] <- "Anthus japonicus"
avtrait$sci_name[avtrait$sci_name=="Charadrius alexandrinus"] <- "Anarhynchus nivosus"
avtrait$sci_name[avtrait$sci_name=="Charadrius montanus"] <- "Anarhynchus montanus"
avtrait$sci_name[avtrait$sci_name=="Charadrius mongolus"] <- "Anarhynchus mongolus"


avtrait3$sci_name[avtrait3$sci_name=="Spizella arborea"] <- "Spizelloides arborea"
avtrait3$sci_name[avtrait3$sci_name=="Ammodramus bairdii"] <- "Centronyx bairdii"
#avtrait3$sci_name[avtrait3$sci_name=="Larus argentatus"] <- "Larus smithsonianus"

#mew gulls were made into 2 species
new_row <- avtrait[avtrait$sci_name == "Larus canus", ]
new_row$sci_name <- "Larus brachyrhynchus"
avtrait <- rbind(avtrait, new_row)
	
bctraits3 <- left_join(birdlist, avtrait, by = "sci_name")

unmatched_av <- bctraits3 %>%
  filter(is.na(AV_ID)) %>%   # replace with a col you expect after join
  select(names(birdlist))

matched_by_ <- unmatched_av %>%
  left_join(avtrait3, by = "sci_name")
bctraits3 <- bctraits3 %>%
  filter(!is.na(AV_ID)) %>%  # keep the matched ones
  bind_rows(matched_by_)

#duplicated(bctraits3$sci_name)#no duplicated, 567 birds
#dupes <- bctraits3[duplicated(bctraits3$sci_name) | duplicated(bctraits3$sci_name, fromLast = TRUE), ]

bctraits.all <- left_join(bctraits3, bctrait)

# ################################################################################
# #IUCN
# redlist <- read.csv(here("Data", "TraitDatabases", "IUCN", "assessments.csv"))
# redlist <- redlist %>% 
#   select(scientificName, redlistCategory, populationTrend)
# #cleaning up some taxonomy so they match:
# redlist$scientificName[redlist$scientificName=="Passerella arborea"] <- "Spizelloides arborea"
# redlist$scientificName[redlist$scientificName=="Haematopus ater"] <- "Haematopus bachmani"
# redlist$scientificName[redlist$scientificName=="Catharacta maccormicki"] <- "Stercorarius maccormicki"
# redlist$scientificName[redlist$scientificName=="Picoides tridactylus"] <- "Picoides dorsalis"
# redlist$scientificName[redlist$scientificName=="Hylatomus pileatus"] <- "Dryocopus pileatus"
# redlist$scientificName[redlist$scientificName=="Icterus bullockiorum"] <- "Icterus bullockii"
# redlist$scientificName[redlist$scientificName=="Butorides striatus"] <- "Butorides virescens" #this
# redlist$scientificName[redlist$scientificName=="Leuconotopicus villosus"] <- "Dryobates villosus" #some taxonomic disagreement it seems, sticking to this one
# 
# 
# 
# bctraits.i <- bctraits.all %>% 
#   select(name, names(birdlist)) %>% 
#             left_join(redlist, by = c("sci_name" = "scientificName"))
# unmatched.i <- bctraits.i %>%
#   filter(is.na(redlistCategory)) %>%   # replace with a col you expect after join
#   select(name, names(birdlist))
# matched_by_i<- unmatched.i %>%
#   left_join(redlist, by = c("name" = "scientificName"))
# 
# bctraits.i<- bctraits.i %>%
#   filter(!is.na(redlistCategory)) %>%  # keep the matched ones
#   bind_rows(matched_by_i)
# 
# bctraits.all <- left_join(bctraits.all, bctraits.i)

###############################################################################
#cleanign it up a bit
bctraits.all <- bctraits.all %>% 
  rename(Elton_common_name = eng_name, Elton_sci_name = name, Elton_syn = synonyms, D_ID = proj_id, D_sci_name = Scientific, mass_g= Mass ) %>% 
  select(Order, Family, sci_name, common_name, status, mass_g, Habitat, Habitat.Density, Migration, Trophic.Level, Trophic.Niche, Primary.Lifestyle, Range.Size, lifespan, ReproAge, clutches.per.year, Kipps.Distance, Hand.Wing.Index, nest.type, majority.nesting.location, most.common.nesting.location, second.nesting.location, nest.category,nest.tree.use, live_tree_nesting_use, snag_nesting_use,majority.foraging.location, most.common.foraging.location, second.foraging.location, AV_ID, Elton_ID, D_ID, Elton_common_name, Elton_sci_name, Elton_syn, D_ID, D_sci_name)

###A few of these species don't have data in these databases: filling in from other sources
#lots of missing data for Pacific Golden-Plover
bctraits.all$lifespan[bctraits.all$common_name=="Pacific Golden-Plover"] <- 6
bctraits.all$clutches.per.year[bctraits.all$common_name=="Pacific Golden-Plover"] <- 1 #can lay a replacement clutch if first is lost
bctraits.all$nest.type[bctraits.all$common_name=="Pacific Golden-Plover"] <- "scrape"
bctraits.all$majority.nesting.location[bctraits.all$common_name=="Pacific Golden-Plover"] <- "ground"
bctraits.all$nest.category[bctraits.all$common_name=="Pacific Golden-Plover"] <- "open"

#lots of missing data for South Polar Skua...breed in antartica, so maybe these arent helpful!
bctraits.all$ReproAge[bctraits.all$common_name=="South Polar Skua"] <- 6 
bctraits.all$clutches.per.year[bctraits.all$common_name=="South Polar Skua"] <- 1 
bctraits.all$nest.type[bctraits.all$common_name=="South Polar Skua"] <- "scrape"
bctraits.all$majority.nesting.location[bctraits.all$common_name=="South Polar Skua"] <- "ground"
bctraits.all$nest.category[bctraits.all$common_name=="South Polar Skua"] <- "open"

#Short-tailed Shearwater - breeds in Australia, summers in Berrings sea
bctraits.all$lifespan[bctraits.all$common_name=="Short-tailed Shearwater"] <- 30 
bctraits.all$ReproAge[bctraits.all$common_name=="Short-tailed Shearwater"] <- 6 
bctraits.all$clutches.per.year[bctraits.all$common_name=="Short-tailed Shearwater"] <- 1 
#bctraits.all$nest.type[bctraits.all$common_name=="Short-tailed Shearwater"] <- "scrape"
#bctraits.all$nesting.location[bctraits.all$common_name=="Short-tailed Shearwater"] <- "ground"
#bctraits.all$nest.category[bctraits.all$common_name=="Short-tailed Shearwater"] <- "open"


#lots of missing data for Pacific Wren - associated with old growth forests AND was recently seperated from winter wren. So where there isnt data for pacific, use data from winter
bctraits.all$lifespan[bctraits.all$common_name=="Pacific Wren"] <- 4 #making it the same as the winter wren, which it was recently split from
bctraits.all$clutches.per.year[bctraits.all$common_name=="Pacific Wren"] <- 1 #can lay a replacement clutch if first is lost
#bctraits.all$majority.nesting.location[bctraits.all$common_name=="Pacific Wren"] <- "?"
bctraits.all$nest.type[bctraits.all$common_name=="Pacific Wren"] <- "cavity"
bctraits.all$nest.category[bctraits.all$common_name=="Pacific Wren"] <- "cavity"
#bctraits.all$Diet.5Cat[bctraits.all$common_name=="Pacific Wren"] <- "Invertebrate"
bctraits.all$nest.tree.use[bctraits.all$common_name=="Pacific Wren"] <- .5
bctraits.all$live_tree_nesting_use[bctraits.all$common_name=="Pacific Wren"] <- .2
bctraits.all$snag_nesting_use[bctraits.all$common_name=="Pacific Wren"] <- .3
bctraits.all$most.common.nesting.location[bctraits.all$common_name=="Pacific Wren"] <- "snag"
bctraits.all$second.nesting.location[bctraits.all$common_name=="Pacific Wren"] <- "ground"
bctraits.all$most.common.foraging.location[bctraits.all$common_name=="Pacific Wren"] <- "ground"
bctraits.all$second.foraging.location[bctraits.all$common_name=="Pacific Wren"] <- "understory"
```

```{r}
#hot off the press BIRDBASE (published sept 20 2025)
birdbase <- read.csv(here("Data", "TraitDatabases", "Birdbase", "BIRDBASE.database.csv"), skip = 1)

birdbase <- birdbase %>% 
  clean_names()
birdbase <- birdbase %>% 
  rename(iucn.2024 = x2024_iucn_red_list_category, forest.use = 33, habitat.breadth = hb, diet.breadth =db, Eco.Spec.Index = esi, latin = 3, former.latin = 5, common.name = 2) %>% 
  select(1:7, iucn.2024, rr, average_mass, elevational_range, forest.use, primary_habitat, habitat.breadth, primary_diet,diet.breadth, Eco.Spec.Index) 
birdbase$forest.use[is.na(birdbase$forest.use)] <- 0 

##ESI: Ecological Specialization Index: log10 (100/[dietary breadth x habitat breadth]), with a maximum of 2 for the most specialized species that only feed on one major food group and live in one major type of habitat (e.g., forest frugivore; Sekercioglu, 2011)
#just get BC birds
birdbase.bc <- left_join(birdlist, birdbase, by = c("sci_name" = "latin"))


unmatched.i <- birdbase.bc %>%
  filter(is.na(ioc_15_1)) %>%   # replace with a col you expect after join
  select(names(birdlist))
matched_by_i<- unmatched.i %>%
  left_join(birdbase, by = c("common_name" = "common.name"))

unmatched.2 <- matched_by_i %>%
  filter(is.na(ioc_15_1)) %>%   # replace with a col you expect after join
  select(names(birdlist))
matched_by_2<- unmatched.2 %>%
  left_join(birdbase, by = c("sci_name" = "former.latin"))

birdbase.bc<- birdbase.bc %>%
  filter(!is.na(ioc_15_1)) %>%  # keep the matched ones
  bind_rows(matched_by_i) %>% 
  filter(!is.na(ioc_15_1)) %>% 
  bind_rows(matched_by_2)

birdbase.bc<- birdbase.bc %>%
  select(-c(ioc_15_1, common.name))
# 

bctraits.all <- left_join(bctraits.all, birdbase.bc)

bctraits.all <- bctraits.all %>% 
 # rename(Elton_common_name = eng_name, Elton_sci_name = name, Elton_syn = synonyms, D_ID = proj_id, D_sci_name = Scientific ) %>% 
  #select(AV_ID, Elton_ID, D_ID, Elton_common_name, Elton_sci_name, Elton_syn, D_ID, D_sci_name) #uncheck this to include these other names/database IDs
  select(Order, Family, sci_name, common_name, status, iucn.2024, Primary.Lifestyle, primary_habitat, Habitat.Density, forest.use, habitat.breadth, primary_diet, diet.breadth, Eco.Spec.Index,Trophic.Level, Trophic.Niche,  Migration, Range.Size, elevational_range, lifespan, ReproAge, average_mass,Kipps.Distance, Hand.Wing.Index, clutches.per.year, nest.tree.use, live_tree_nesting_use, snag_nesting_use, majority.nesting.location, most.common.nesting.location, second.nesting.location, nest.type, nest.category, majority.foraging.location, most.common.foraging.location, second.foraging.location)
  
bctraits.all <- bctraits.all %>% 
  janitor::clean_names()

write.csv(bctraits.all, here("Data", "cleaned", "BC_bird_traits.csv"), row.names = FALSE)

```

Read me:

"order" - [BC bird list]
"family" - [BC bird list]
"sci_name" - [BC bird list]
"common_name" - [BC bird list]
"status" - status in BC, including rare/accidental [BC bird list]

"iucn_2024" - 2024 IUCN status [Birdbase]
    EX	Extinct
    CR	Critically Endangered
    EN	Endangered
    VU	Vulnerable
    NT	Near-threatened
    LC	Least Concern
    DD	Data Deficient
    
"primary_lifestyle" - [avonet]
    Aerial = species spends much of the time in flight, and hunts or forages predominantly on the wing; 
    Terrestrial = species spends majority of its time on the ground, where it obtains food while either walking or hopping (note this includes species that also wade in water with their body raised above the water); 
    Insessorial = species spends much of the time perching above the ground, either in branches of trees and other vegetation (i.e. arboreal), or on other raised substrates including rocks, buildings, posts, and wires; 
    Aquatic = species spends much of the time sitting on water, and obtains  food while afloat or when diving under the water's surface; Generalist = species has no primary lifestyle because it spends time in different lifestyle classes"

"primary_habitat" - The main habitat type utilized by a species [birdbase]
    Forest, secondary forest, swamp forest, tree-fall gaps, taiga, igapo, varzea
    Shrubland, scrub, secondary growth (with few trees), cerrado, campo, karoo, thickets, roadside growth, heaths, copses, hedgerow, vine tangle, caatinga, chaco
    Savanna, arid plains, wooded grassland, pampas, campos,
    Grasslands, high altitude flats, puna, altiplano, tundra, tussock, pastures, steppe, paramo, moorland, plateaus, open vegetation
    Plains, dry & open areas, semi-desert, steppe, tundra, arid and semi-arid grassland
    Rocky areas, cliffs, outcrop, inselberg, koppi, escarpment
    Desert, sand dune (not coastal)
    Artificial, agricultural, farms, plantations, suburban, quarry, mine, excavation, dams and man-made lakes
    Sea coast, mangrove, estuary, bays, shores, fjords (only sea coast), coastal dune
    Riparian, riverine, gallery forest, stream, running water, wooded ravines
    Wetlands, lakes, salt lakes, marsh, reedbed
    Open sea, pelagic
    Woodland: Acacia woodland, tropical deciduous/dry forest, savanna woodland, palm groves, miombo woodland, thorn forest, Polylepis woodland, pine-oak woodland

    
"habitat_density" - [avonet]
    1 = Dense habitats. Species primarily lives in the lower or middle storey of forest, or in dense thickets, dense shrubland etc.
    2 = Semi-open habitats. Species primarily lives in open shrubland, scattered bushes, parkland, low dry or deciduous forest, thorn forest. 
    3 = Open habitats. Species primarily lives in desert, grassland, open water, low shrubs, rocky habitats, seashores, cities. Also applies to species living mainly on top of forest canopy (i.e. mostly in the open)
    
"forest_use" - extent to which forest is prefered as a habitat. Ranges from 1-6, where 1 = forest is most prefered, 6 = least prefered. NA indicates forest not used at all [birdbase]

"habitat_breadth" - the number of major habitats used. Lower = more habitat specialized, higher = broader habitat use [birdbase]

"primary_diet" - Majority of diet. Else, if none of the weighted categories area majority, used "Carnivore" if the species primarily eat a variety of animal matter, or ''Herbivore' if it eats a variety of plant matter. If a combination of animal and plant, assigned 'Omnivore.' [birdbase]

"diet_breadth" - Diet breadth, the number of major food types consumed [birdbase]. Lower = more diet  specialized, higher = broader diet

"eco_spec_index" - Ecological Specialization Index: log10 (100/[dietary breadth x habitat breadth]), with a maximum of 2 for the most specialized species that only feed on one major food group and live in one major type of habitat (e.g., forest frugivore; Sekercioglu, 2011) [birdbase]

"trophic_level" - [avonet]
    Herbivore = species obtaining at least 70% of food resources from plants; 
    Carnivore = species obtaining at least 70% of food resources by consuming live invertebrate or vertebrate animals; 
    Scavenger = species obtaining at least 70% of food resources from carrion or refuse; 
    Omnivore = species obtaining resources from multiple trophic level in roughly equal proportion

"trophic_niche" - [avonet]
    "Frugivore = species obtaining at least 60% of food resources from fruit; 
    Granivore = species obtaining at least 60% of food resources from seeds or nuts; 
    Nectarivore =  species obtaining at least 60% of food resources from nectar; 
    Herbivore = species obtaining at least 60% of food resources from other plant materials in non-aquatic systems, including leaves, buds, whole flowers etc.; 
    Herbivore aquatic = species obtaining at least 60% of food resources from plant materials in aquatic systems, including algae and aquatic plant leaves; 
    Invertivore = species obtaining at least 60% of food resources from invertebrates in terrestrial systems, including insects, worms, arachnids, etc.; 
    Vertivore = species obtaining at least 60% of food resources from vertebrate animals in terrestrial systems, including mammals, birds, reptiles etc.; 
    Aquatic Predator = species obtaining at least 60% of food resources from vertebrate and invertebrate animals in aquatic systems, including fish, crustacea, molluscs, etc; 
    Scavenger = species obtaining at least 60% of food resources from carrion, offal or refuse; Omnivore = Species using multiple niches, within or across trophic levels, in relatively equal proportions "


"migration" - [avonet]
    1 = Sedentary. 
    2 = Partially migratory, i.e. minority of population migrates long distances, or most of population undergoes short-distance migration, nomadic movements, distinct altitudinal migration, etc.
    3 = Migratory, i.e. majority of population undertakes long-distance migration"
    
"range_size" - ""The total area of the mapped range of the species (not the Extent of Occurrence [EOO]). We used maps shared by BirdLife International and restricted our analysis to areas of the range coded as Presence = 1 (Extant only),     Origin = 1 & 2 (Native & Reintroduced), Seasonal = 1 & 2 (Resident and breeding). We calculated the total combined mapped area of these parts of the range using the areaPolygon function from the R package geosphere (Hijmans et al.,        2011). This function accurately calculates the area in the World Geodetic System (WGS84) projection using spherical distances" [avonet]

"elevational_range" - The difference between a species' normal lowest and highest elevational extents [birdbase]

"lifespan" - maximum observed lifespan, years [dubovyk]

"repro_age" - mean age of first breeding [dubovyk]

"average_mass" - the average value across males, females, and unsexed individuals in the dataset [birdbase]

"kipps_distance" - Length from the tip of the first secondary feather to the tip of the longest primary in mm [avonet]

"hand_wing_index" - 100*DK/Lw, where DK is Kipp’s distance and Lw is wing length (i.e., Kipp’s distance corrected for wing size) [avonet]

"clutches_per_year" - mean number of successful nesting  attempts a year [dubovyk]

"nest_tree_use" - % of total nesting preference (ntree+nssnag)/100) %>% #to what scale do they use trees to nest? Essentially adding the % they use deciduous, coniferous, and snags, so out of 100% [dubovyk]

live_tree_nesting_use - % of nesting preference for live trees out of 100% [dubovyk]

snag_nesting_use - % of nesting preference for snags out of 100% [dubovyk]

"majority_nesting_location" - majority (>51%) prevalence of use of nesting location. If NA, not one preferred location [eltontraits]
    "ground"
    NA                
    "float"
    "tree"
    "snag"
    "grass"
    "human.structure"
    "cliff"
    "shrub"
    "bank"
    "?" 

"most_common_nesting_location" - most common nesting location [eltontraits]
    "ground"
    NA   = no data             
    "float"
    "tree"
    "snag"
    "grass"
    "human.structure"
    "cliff"
    "shrub"
    "bank"
    "?" 

"second_nesting_location" - second most common nesting location. If NA, only uses the most common location [elton traits]
    "float"
    NA
    "grass" 
    "snag"
    "tree"
    "cliff"
    "shrub"
    "human.structure"
    "ground"
    "bank"
    "cactus"
    "tangle"   

"nest_type" - specific nest type (original column to nest_categoty) [dubovyk]

"nest_category" - lumped category for nest types [dubovyk]
    "cup", "gourd", "sphere", "gourd", "saucer", "chamber", "oven", "pend" ==> _built.structure_
    "scrape" or "no" ==> _open_
    "platform"
    "cavity"
    "crevice"
    "burrow"
    "paras" ==> parasite

"majority_foraging_location" - majority (>51%) prevalence of foraging strategy. If NA, not one preferred location [eltontraits]

"most_common_foraging_location" - most common foraging strategy [eltontraits]

"second_foraging_location"- second most common foraging strategy. If NA, only uses the most common strategy [eltontraits]

```{r Fire Index}

index <- bctraits.all %>% 
  mutate(index_primary_lifestyle = ifelse(primary_lifestyle=="Insessorial", 1, 0),
         index_primary_habitat = ifelse(primary_habitat == "Forest"|primary_habitat == "Woodland", -1, ifelse(primary_habitat == "Shrub"|primary_habitat == "Grassland"|primary_habitat == "Plains", 1, 0)),
         index_habitat_density = ifelse(habitat_density == "dense", -1, ifelse(is.na(habitat_density), 0, 1)),
         index_forest_use = ifelse(forest_use == 1, -1, 0),
         index_eco_spec_index = ifelse(eco_spec_index >1, -1,0),
         index_foraging_location = ifelse(most_common_foraging_location=="canopy"|most_common_foraging_location == "midhigh", -1, ifelse(most_common_foraging_location=="ground"|most_common_foraging_location == "understory", 1, 0)),
         index_trophic_niche = ifelse(trophic_niche == "Invertivore"|trophic_niche == "Nectarivore"|trophic_niche == "Granivore"|trophic_niche=="Frugivore", 1, ifelse(trophic_niche == "Herbivore terrestrial", -1, 0)),
         #20th percentile for range size will be considered "small"
         index_range_size = ifelse(range_size<(quantile(range_size, probs = 0.20, na.rm =T)), -1, 0),
         index_migration = ifelse(migration == "sedentary", -1, 0),
         #hwi maybe not the best...would mean that vultures are least dispersing??
         index_kipps = ifelse(kipps_distance<(quantile(kipps_distance, probs = 0.20, na.rm =T)), -1, 0),
         index_live_tree = ifelse(live_tree_nesting_use >.90, -1, 0),
         #only one spp does snags>90
         index_snag_use = ifelse(snag_nesting_use>.60, 1, 0),
         index_nesting_location = ifelse(most_common_nesting_location == "tree", -1, ifelse(most_common_nesting_location == "snag"|most_common_nesting_location == "ground"|most_common_nesting_location=="grass"|most_common_nesting_location == "shrub", 1, 0)),
         index_nest_type = ifelse(nest_category=="cavity", 1, 0),
index_sum = rowSums(across(starts_with("index")), na.rm = TRUE))


```

```{r}


# Create the figure: Lollipop Chart
# NOTE: Replace 'species' with the actual species column name if it is different
# We reorder the species (Y-axis) based on the index_sum (X-axis) for better visualization
(index1 <- ggplot(index, aes(x = index_sum, 
                  y = reorder(sci_name, index_sum), 
                  color = index_sum)) +
  geom_segment(aes(x = 0, xend = index_sum, y = reorder(sci_name, index_sum), yend = reorder(sci_name, index_sum)),
               linewidth = 0.5, alpha = 0.7) +
  geom_point(size = 2.5) +
  scale_color_gradient2(low = "red", mid = "gray", high = "blue", 
                        midpoint = 0, name = "Index Score") +
  labs(x = "Fire Vulnerability Index Score", y = "Species") +
  theme_classic(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 8), # Smaller font for potentially many species
    panel.grid.major.y = element_blank(), # Remove horizontal lines for clean look
    legend.position = "bottom"
  ))
#Picidae

(woodpeckers <- index %>% filter(family == " Picidae") %>% 
    ggplot(aes(x = index_sum, 
                  y = reorder(common_name, index_sum), 
                  color = index_sum)) +
  geom_segment(aes(x = 0, xend = index_sum, y = reorder(common_name, index_sum), yend = reorder(common_name, index_sum)),
               linewidth = 0.5, alpha = 0.7) +
  geom_point(size = 2.5) +
  scale_color_gradient2(low = "red", mid = "gray", high = "blue", 
                        midpoint = 0, name = "Index Score") +
  labs(title = "Picidae", x = "Fire Vulnerability Index Score", y = "Species") +
  theme_classic(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 8), # Smaller font for potentially many species
    panel.grid.major.y = element_blank(), # Remove horizontal lines for clean look
    legend.position = "bottom"
  ))

#Tyrannidae

(tyran <- index %>% filter(family == " Tyrannidae") %>% 
    ggplot(aes(x = index_sum, 
                  y = reorder(common_name, index_sum), 
                  color = index_sum)) +
  geom_segment(aes(x = 0, xend = index_sum, y = reorder(common_name, index_sum), yend = reorder(common_name, index_sum)),
               linewidth = 0.5, alpha = 0.7) +
  geom_point(size = 2.5) +
  scale_color_gradient2(low = "red", mid = "gray", high = "blue", 
                        midpoint = 0, name = "Index Score") +
  labs(title = "Tyrannidae", x = "Fire Vulnerability Index Score", y = "Species") +
  theme_classic(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    axis.text.y = element_text(size = 8), # Smaller font for potentially many species
    panel.grid.major.y = element_blank(), # Remove horizontal lines for clean look
    legend.position = "bottom"
  ))

ggsave(here("Figures", "index.first.try.png"), plot = index1, width = 20, height =20)
ggsave(here("Figures", "index.first.try.picidae.png"), plot = woodpeckers, width = 8, height =6)
ggsave(here("Figures", "index.first.try.tyrannidae.png"), plot = tyran, width = 8, height =6)


```

```{r}
#update spp names
# https://ecoinfor.shinyapps.io/UTaxonstandOnline/

# data(spExample)
# data(databaseExample)
# 
# library(openxlsx)
# dat1 <- read.xlsx("Birds_ITIS_database.xlsx")
# 
# res <- nameMatch(spList=birdlist, spSource=databaseExample, author = TRUE, max.distance= 1)
# head(res)
```


simplifying categories:
- nest types: simplify to broader categories (for fire: cup, scape, cavity, [bank/crevice] 
  change outside structres ie. gourd, sphere, pendant, saucer, chamber, oven, cup --> MAKE ALL THE SAME... will be similarly affected to cups. VS TREE CAVITY; rockCREVICE/crack; burrow (+/-?) ; open[no, scrape--> combined these into one category] platform[negatively affected]  (tree; burrows; crevice[look at definition]) VS exposed )
- take out lat/long
- keep Kipp distance and hand wing distance [some direction]

foraging strategy from elton tratis: assign the majoity % for each (>50%)

from Du..: see if there are any extra records for hand wing index

add in number of clutched (but not age of maturity etc)

TODO:
- make table of tratis and directions in google drive (similar to the FIRE paper)
