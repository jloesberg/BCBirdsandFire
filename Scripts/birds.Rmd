---
title: "bird_data"
author: "JL"
date: "`r Sys.Date()`"
output: html_document
---
_to do:_
-pivot longer the reproduction dfs
-check in with jenny about the best wya to fill in the small gaps
-check in about the traits weve found (ie, could they be coarser?)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here) 
library(tidyverse)
library(janitor)
```

_Traits we discussed:_
nest type (ground, open-cup, cavity), nest location (ground, mid-canopy, canopy), foraging height (ground, mid-canopy, canopy), horizontal foraging strategy (ground, edge, core), diet (herbivore, invertivore, omnivore), morphological attributes (body mass, wing length, bill size), and migratory behaviour (resident/short-distance migrants, long-distance migrants)
Plus: Range size, population estimate, nest type, specialization to habitat, migration

```{r read in bc bird list}
birdlist <- read.csv(here("Data", "BirdLists", "bc_birds_checklist.csv"))
#test <- read.csv(here("Data", "BirdLists", "bc_birds_avibase_clements_2025.csv"))
birdlist <- birdlist%>%
  filter(if_any(everything(), ~ . != "" & !is.na(.)))
#duplicated(birdlist$common_name)#no duplicated, 567 birds

#setdiff(birdlist$sci_name, test$sci_name)

```

```{r read in trait data base available databases}
dtrait <- read.csv(here("Data", "TraitDatabases", "Dubovyk_trait_database.csv")) #> nest <- dtrait %>% select(name, eng_name, nest, nsbank, nsgroun, nsgrass, nsclif, nsbuild, nsshru, nsdeci, nsconi, nssnag, nsfloat, nscact, nstang, ntree, nesting.location)

dtrait <- dtrait %>% 
  mutate(ntree = nsdeci+nsconi,
         nest.tree.use = (ntree+nssnag)/100) %>% #to what scale do they use trees to nest? Essentially adding the % they use deciduous, coniferous, and snags
  select(name, synonyms, proj_id, et_id, synonyms, mlife, matage,nest, nsbank, nsgroun, nsgrass, nsclif, nsbuild, nsshru, nssnag, nscact, nstang, nsfloat, ntree, attem, eng_name,nest.tree.use) %>% 
  rename(Elton_ID = et_id,lifespan = mlife, ReproAge = matage,  nest.type = nest, clutches.per.year = attem,
         bank = nsbank, ground = nsgroun, grass = nsgrass, cliff = nsclif, human.structure = nsbuild, shrub = nsshru, snag = nssnag, float = nsfloat, cactus = nscact, tangle = nstang, tree = ntree)

#correcting some taxonony
dtrait$synonyms[dtrait$name=="Bubulcus ibis"] <- "Ardea ibis"
dtrait$synonyms[dtrait$name=="Accipiter cooperii"] <- "Astur cooperii"
dtrait$synonyms[dtrait$name=="Hylatomus pileatus"] <- "Dryocopus pileatus"
dtrait$synonyms[dtrait$synonyms=="Anas penelope"] <- "Mareca penelope"
dtrait$synonyms[dtrait$name=="Melanitta fusca"] <- "Melanitta deglandi"
dtrait$synonyms[dtrait$name=="Dendragapus canadensis"] <- "Canachites canadensis"
dtrait$synonyms[dtrait$name=="Larus argentatus"] <- "Larus smithsonianus"
dtrait$synonyms[dtrait$name=="Nannopterum auritus"] <- "Nannopterum auritum"
dtrait$synonyms[dtrait$proj_id==3070] <- "Tyto furcata"
dtrait$Elton_ID[dtrait$proj_id==4680] <- 9750 #this one doesnt have its elton id for some reason..
dtrait$synonyms[dtrait$proj_id==2920] <- "Astur atricapillus"
dtrait$synonyms[dtrait$proj_id==2180] <- "Larus brachyrhynchus"
dtrait$synonyms[dtrait$proj_id=="5240"] <- "NA"
dtrait$eng_name[dtrait$proj_id==3255] <- "White-winged Parakeet"
dtrait$name[dtrait$proj_id==3255] <- "Brotogeris versicolurus"

#making the nest category more broad:
#gourd, sphere, pendant, saucer, chamber, oven, cup --> MAKE ALL THE SAME... will be similarly affected to cups. VS TREE CAVITY; rockCREVICE/crack; burrow (+/-?) ; open[no, scrape--> combined these into one category] platform[negatively affected]  (tree; burrows; crevice[look at definition]) VS exposed 
dtrait <- dtrait %>% 
  mutate(nest.category = if_else(nest.type == "cup"|nest.type == "gourd"|nest.type == "sphere"|nest.type == "gourd"|nest.type == "saucer"|nest.type == "chamber"|nest.type == "oven"|nest.type == "pend", "built.structure", if_else(nest.type == "scrape"|nest.type == "no", "open", nest.type)))


#get nesting substrates
cols_to_check <- c("bank", "ground", "grass", 'cliff', 'human.structure', "shrub", "float", "snag", 'cactus', "tangle", "tree")
dtrait <- dtrait %>%
    mutate(majority.nesting.location = if_else(ground>51, "ground", if_else(grass>51, "grass", if_else(shrub>51, "shrub", if_else(tree>51, "tree", if_else(snag>51, "snag", if_else(bank>51, "bank", if_else(cliff>51, "cliff", if_else(human.structure>51, "human.structure", if_else(tangle>51, "tangle", if_else(float>51, "float", NA))))))))))) %>%
  rowwise() %>%
  mutate(
    row_values = list(c_across(all_of(cols_to_check))),
    sorted_indices = list(order(row_values, decreasing = TRUE)),
    most.common.nesting.location = cols_to_check[sorted_indices[1]],
    second.nesting.location = ifelse(
      # Condition: Is the second highest value equal to 0?
      row_values[sorted_indices[2]] == 0,
      # If TRUE: Assign NA (must be type character to match column names)
      NA_character_, 
      # If FALSE: Assign the column name
      cols_to_check[sorted_indices[2]])) %>% 
    ungroup() %>%
  select(-c(row_values, sorted_indices, bank, ground, grass, cliff, human.structure, shrub, float, snag, cactus, tangle, tree)) %>%
  ungroup()
###########################################################################################

#Ecology data paper - ELTON TRAITS
eco_t <- read.delim(here("Data", "TraitDatabases", "Ecology_BirdFuncDat.txt"), sep = "\t", header = T)
eco_t <- eco_t %>% 
  mutate(ForStrat.water = ForStrat.watbelowsurf+ForStrat.wataroundsurf) %>% 
  select(SpecID, Scientific, English, starts_with("ForStrat"), -c(ForStrat.Source, ForStrat.SpecLevel, ForStrat.EnteredBy, ForStrat.watbelowsurf, ForStrat.wataroundsurf)) %>% 
  rename(Elton_ID = SpecID, eng_name = English) %>% 
  filter(!is.na(Elton_ID))
eco_t$Scientific[eco_t$Elton_ID=="9750"] <- "Troglodytes hiemalis"

#get foraging strategy group:
cols_to_check <- eco_t %>% 
  select(starts_with("ForStrat")) %>% # Select the columns
  names()   
#cols_to_check <- c("ground", "understory", "midhigh", 'canopy', 'aerial', "water")

eco_t <- eco_t %>%
  mutate(majority.foraging.location = case_when(
      ForStrat.ground    > 51 ~ "ground",
      ForStrat.understory > 51 ~ "understory",
      ForStrat.midhigh   > 51 ~ "midhigh",
      ForStrat.canopy    > 51 ~ "canopy",
      ForStrat.aerial    > 51 ~ "aerial",
      ForStrat.water     > 51 ~ "water",
      TRUE ~ NA_character_)) %>%   
  rowwise() %>%
  mutate(
    row_values = list(c_across(all_of(cols_to_check))),
    sorted_indices = list(order(row_values, decreasing = TRUE)),
    most.common.foraging.location = cols_to_check[sorted_indices[1]],
    second.foraging.location = ifelse(
      # Condition: Is the second highest value equal to 0?
      row_values[sorted_indices[2]] == 0,
      # If TRUE: Assign NA (must be type character to match column names)
      NA_character_, 
      # If FALSE: Assign the column name
      cols_to_check[sorted_indices[2]])) %>% 
    ungroup() %>%
  select(-c(row_values, sorted_indices, ForStrat.ground, ForStrat.understory, ForStrat.midhigh, ForStrat.canopy, ForStrat.aerial, ForStrat.water))
eco_t$most.common.foraging.location <- gsub("ForStrat.", "", eco_t$most.common.foraging.location)
eco_t$second.foraging.location <- gsub("ForStrat.", "", eco_t$second.foraging.location)

#connect these based on the elton traits et_id
de.trait <- full_join(eco_t, dtrait, by = c("Elton_ID", "eng_name")) %>% 
   mutate(
    Scientific = coalesce(Scientific, name)  # use 'name' only if Scientific is NA
  )

  
#get bc birds
bctrait <- left_join(birdlist ,de.trait, by = c("sci_name" = "Scientific"))

unmatched <- bctrait %>%
  filter(is.na(Elton_ID)) %>%   # replace with a col you expect after join
  select(names(birdlist))
matched_by_common <- unmatched %>%
  left_join(de.trait, by = c("common_name" = "eng_name"))

bctrait <- bctrait %>%
  filter(!is.na(Elton_ID)) %>%  # keep the matched ones
  bind_rows(matched_by_common)

unmatched2 <- bctrait %>%
  filter(is.na(Elton_ID)) %>%   # replace with a col you expect after join
  select(names(birdlist))
matched_by_syn <- unmatched2 %>%
  left_join(de.trait, by = c("sci_name" = "synonyms"))

bctrait <- bctrait %>%
  filter(!is.na(Elton_ID)) %>%  # keep the matched ones
  bind_rows(matched_by_syn)



############################
#Avonet database
avtrait <- read.csv(here("Data", "TraitDatabases", "ELEData", "TraitData", "AVONET1_BirdLife.csv"))
avtrait3 <- read.csv(here("Data", "TraitDatabases", "ELEData", "TraitData", "AVONET3_BirdTree.csv"))

avtrait <- avtrait %>% 
  rename(sci_name = Species1,
         AV_ID = Sequence) %>% 
  select(AV_ID, sci_name, Mass, Habitat, Habitat.Density, Migration, Trophic.Level, Trophic.Niche, Primary.Lifestyle, Range.Size)

avtrait3 <- avtrait3 %>% 
  rename(sci_name = Species3) %>% 
  select(sci_name, Mass, Habitat, Habitat.Density, Migration, Trophic.Level, Trophic.Niche, Primary.Lifestyle, Range.Size)
#changing some of the codes to something more readable:
avtrait$Habitat.Density[avtrait$Habitat.Density == 1] <- "dense"
avtrait$Habitat.Density[avtrait$Habitat.Density == 2] <- "semiopen"
avtrait$Habitat.Density[avtrait$Habitat.Density == 3] <- "open"

avtrait$Migration[avtrait$Migration == 1] <- "sedentary"
avtrait$Migration[avtrait$Migration == 2] <- "partial"
avtrait$Migration[avtrait$Migration == 3] <- "migratory"

avtrait3$Habitat.Density[avtrait3$Habitat.Density == 1] <- "dense"
avtrait3$Habitat.Density[avtrait3$Habitat.Density == 2] <- "semiopen"
avtrait3$Habitat.Density[avtrait3$Habitat.Density == 3] <- "open"

avtrait3$Migration[avtrait3$Migration == 1] <- "sedentary"
avtrait3$Migration[avtrait3$Migration == 2] <- "partial"
avtrait3$Migration[avtrait3$Migration == 3] <- "migratory"

#fixing taxonomy - there arent many, so doing it by hand (and there are no common names to help out)
avtrait$sci_name[avtrait$sci_name=="Falcipennis canadensis"] <- "Canachites canadensis"
avtrait$sci_name[avtrait$sci_name=="Haematopus ater"] <- "Haematopus bachmani"
avtrait$sci_name[avtrait$sci_name=="Bubulcus ibis"] <- "Ardea ibis"
avtrait$sci_name[avtrait$sci_name=="Accipiter cooperii"] <- "Astur cooperii"
avtrait$sci_name[avtrait$sci_name=="Hylatomus pileatus"] <- "Dryocopus pileatus"
avtrait$sci_name[avtrait$sci_name=="Anas penelope"] <- "Mareca penelope"
#avtrait$sci_name[avtrait$sci_name=="Melanitta fusca"] <- "Melanitta deglandi"
#avtrait$sci_name[avtrait$sci_name=="Dendragapus canadensis"] <- "Canachites canadensis"
#avtrait$sci_name[avtrait$sci_name=="Larus argentatus"] <- "Larus smithsonianus"
avtrait$sci_name[avtrait$sci_name=="Nannopterum auritus"] <- "Nannopterum auritum"
avtrait$sci_name[avtrait$sci_name=="Tyto alba"] <- "Tyto furcata"
avtrait$sci_name[avtrait$sci_name=="Accipiter gentilis"] <- "Astur atricapillus"
avtrait$sci_name[avtrait$sci_name=="Steganopus tricolor"] <- "Phalaropus tricolor"
avtrait$sci_name[avtrait$sci_name=="Catharacta maccormicki"] <- "Stercorarius maccormicki"
avtrait$sci_name[avtrait$sci_name=="Larus philadelphia"] <- "Chroicocephalus philadelphia"
avtrait$sci_name[avtrait$sci_name=="Larus ridibundus"] <- "Chroicocephalus ridibundus"
avtrait$sci_name[avtrait$sci_name=="Larus atricilla"] <- "Leucophaeus atricilla"
avtrait$sci_name[avtrait$sci_name=="Larus argentatus"] <- "Larus vegae" ## these were all one species, double check this!
avtrait$sci_name[avtrait$sci_name=="Larus pipixcan"] <- "Leucophaeus pipixcan"
avtrait$sci_name[avtrait$sci_name=="Sula leucogaster"] <- "Sula brewsteri"
avtrait$sci_name[avtrait$sci_name=="Ixobrychus exilis"] <- "Botaurus exilis"
avtrait$sci_name[avtrait$sci_name=="Butorides striatus"] <- "Butorides virescens"
avtrait$sci_name[avtrait$sci_name=="Picoides tridactylus"] <- "Picoides dorsalis"
avtrait$sci_name[avtrait$sci_name=="Leuconotopicus villosus"] <- "Dryobates villosus" #some taxonomic disagreement it seems, sticking to this one
#avtrait$sci_name[avtrait$sci_name=="Charadrius mexicanus"] <- "Himantopus mexicanus" #this one not in avonet1
#avtrait$sci_name[avtrait$sci_name=="Butorides striatus"] <- "Butorides virescens" #this one not in avonet1
avtrait$sci_name[avtrait$sci_name=="Leuconotopicus albolarvatus"] <- "Dryobates albolarvatus"
avtrait$sci_name[avtrait$sci_name=="Regulus calendula"] <- "Corthylio calendula"
avtrait$sci_name[avtrait$sci_name=="Icterus galbula"] <- "Icterus bullockii"
avtrait$sci_name[avtrait$sci_name=="Anthus rubescens"] <- "Anthus japonicus"
avtrait$sci_name[avtrait$sci_name=="Charadrius alexandrinus"] <- "Anarhynchus nivosus"
avtrait$sci_name[avtrait$sci_name=="Charadrius montanus"] <- "Anarhynchus montanus"
avtrait$sci_name[avtrait$sci_name=="Charadrius mongolus"] <- "Anarhynchus mongolus"


avtrait3$sci_name[avtrait3$sci_name=="Spizella arborea"] <- "Spizelloides arborea"
avtrait3$sci_name[avtrait3$sci_name=="Ammodramus bairdii"] <- "Centronyx bairdii"
#avtrait3$sci_name[avtrait3$sci_name=="Larus argentatus"] <- "Larus smithsonianus"

#mew gulls were made into 2 species
new_row <- avtrait[avtrait$sci_name == "Larus canus", ]
new_row$sci_name <- "Larus brachyrhynchus"
avtrait <- rbind(avtrait, new_row)
	
bctraits3 <- left_join(birdlist, avtrait, by = "sci_name")

unmatched_av <- bctraits3 %>%
  filter(is.na(AV_ID)) %>%   # replace with a col you expect after join
  select(names(birdlist))

matched_by_ <- unmatched_av %>%
  left_join(avtrait3, by = "sci_name")
bctraits3 <- bctraits3 %>%
  filter(!is.na(AV_ID)) %>%  # keep the matched ones
  bind_rows(matched_by_)

#duplicated(bctraits3$sci_name)#no duplicated, 567 birds
#dupes <- bctraits3[duplicated(bctraits3$sci_name) | duplicated(bctraits3$sci_name, fromLast = TRUE), ]

bctraits.all <- left_join(bctraits3, bctrait)

# ################################################################################
# #IUCN
# redlist <- read.csv(here("Data", "TraitDatabases", "IUCN", "assessments.csv"))
# redlist <- redlist %>% 
#   select(scientificName, redlistCategory, populationTrend)
# #cleaning up some taxonomy so they match:
# redlist$scientificName[redlist$scientificName=="Passerella arborea"] <- "Spizelloides arborea"
# redlist$scientificName[redlist$scientificName=="Haematopus ater"] <- "Haematopus bachmani"
# redlist$scientificName[redlist$scientificName=="Catharacta maccormicki"] <- "Stercorarius maccormicki"
# redlist$scientificName[redlist$scientificName=="Picoides tridactylus"] <- "Picoides dorsalis"
# redlist$scientificName[redlist$scientificName=="Hylatomus pileatus"] <- "Dryocopus pileatus"
# redlist$scientificName[redlist$scientificName=="Icterus bullockiorum"] <- "Icterus bullockii"
# redlist$scientificName[redlist$scientificName=="Butorides striatus"] <- "Butorides virescens" #this
# redlist$scientificName[redlist$scientificName=="Leuconotopicus villosus"] <- "Dryobates villosus" #some taxonomic disagreement it seems, sticking to this one
# 
# 
# 
# bctraits.i <- bctraits.all %>% 
#   select(name, names(birdlist)) %>% 
#             left_join(redlist, by = c("sci_name" = "scientificName"))
# unmatched.i <- bctraits.i %>%
#   filter(is.na(redlistCategory)) %>%   # replace with a col you expect after join
#   select(name, names(birdlist))
# matched_by_i<- unmatched.i %>%
#   left_join(redlist, by = c("name" = "scientificName"))
# 
# bctraits.i<- bctraits.i %>%
#   filter(!is.na(redlistCategory)) %>%  # keep the matched ones
#   bind_rows(matched_by_i)
# 
# bctraits.all <- left_join(bctraits.all, bctraits.i)

###############################################################################
#cleanign it up a bit
bctraits.all <- bctraits.all %>% 
  rename(Elton_common_name = eng_name, Elton_sci_name = name, Elton_syn = synonyms, D_ID = proj_id, D_sci_name = Scientific, mass_g= Mass ) %>% 
  select(Order, Family, sci_name, common_name, status, mass_g, Habitat, Habitat.Density, Migration, Trophic.Level, Trophic.Niche, Primary.Lifestyle, Range.Size, lifespan, ReproAge, clutches.per.year, nest.type, majority.nesting.location, most.common.nesting.location, second.nesting.location, nest.category, majority.foraging.location, most.common.foraging.location, second.foraging.location, AV_ID, Elton_ID, D_ID, Elton_common_name, Elton_sci_name, Elton_syn, D_ID, D_sci_name)
  







#they have perc for nesting substrate BUT maybe unhelpful for this project
##which traits do we want here?
# this database has" 23 functional traits were used that can be partitioned into categories of ecological influence and importance within habitat filtering: metadata at https://zenodo.org/records/13351162
#filter to just get the BC species:
##there are differing scientific names and differing common names!

#############################################
#global_nest_data from catherine heard
##this has a lot of information but isnt easily sortable/able to be used in coding. May have to go through by hand for some of the species.
# nest <- read.csv(here("Data", "TraitDatabases", "catherinesheard-global-nest-data", "global_nest_data.csv"))
# nest <- nest %>%
#   mutate(across(where(is.character), ~na_if(., "no info"))) %>% 
#   rename(sci_name = Species.scientific.name) %>% 
#   select(sci_name, Raw.nest.info, Nest.structure, Nest.location) %>% 
#   group_by(sci_name) %>% 
#   slice(1) %>% 
#   mutate(across(everything(), ~ ifelse(grepl(",|uncertain|artificial|\\b|\\bnone\\b", ., ignore.case = TRUE), NA, .)))#there are multiple records for each species, just look at the first entry

# ############################################
# nest.trait <- read.csv(here("Data", "TraitDatabases", "catherinesheard-global-nest-data", "global_nest_data.csv"))
# nest.trait <- nest.trait %>% 
#   rename(sci_name = Species.scientific.name) %>% 
#   filter(Source == "BNO")
# 
# nest.trait <- left_join(birdlist, nest.trait)
# ###########################################
# 
# ## Combine the ecology data paper and the avonet database, as they cover different things:
# 
# bctraits <- left_join(bctraits2, bctraits3)
# #there are a couple of spp where the eco db has mass values vut avonet does,just coalesce those over where its NA in the avonet db
# bctraits <- bctraits %>% 
#   mutate(Mass = if_else(is.na(Mass), coalesce(BodyMass.Value), Mass),
#          Mass = round(Mass, 1)) %>% 
#   select(-BodyMass.Value)
# #both of those df have values fo rmass and sometimes dont overlap - make a column that is a combination of the two.
# 
# #add in the dtraits
# bctraits <- left_join(bctraits, bctraits.nabirds)
# 
# bctraits <- left_join(bctraits, nest, by = "sci_name")
# bctraits <- bctraits %>% 
#   mutate(nest.type = if_else(is.na(nest.type), coalesce(Nest.structure), nest.type),
#          nesting.location = if_else(is.na(nesting.location), coalesce(Nest.location), nesting.location)) %>% 
#   select(-c(Raw.nest.info, Nest.structure, Nest.location))
# 
# ###################################################################################
#these problems are solved!
# #which species do we still need nesting info for?
 # nest.na <- nest %>% 
 #   filter(is.na(nesting.location)) %>% 
 #  left_join(birdlist, by = c("eng_name" = "common_name")) %>% 
 #  filter(!is.na(Order))
#write.csv(nest.na, here("Data", "cleaned", "BC_missing.nest.location.csv"), row.names = FALSE)

#remove(avtrait, bctraits1,bctraits2,bctraits3,dtrait,eco_t,nest)


###A few of these species don't have data in these databases: filling in from other sources
#lots of missing data for Pacific Golden-Plover
bctraits.all$lifespan[bctraits.all$common_name=="Pacific Golden-Plover"] <- 6
bctraits.all$clutches.per.year[bctraits.all$common_name=="Pacific Golden-Plover"] <- 1 #can lay a replacement clutch if first is lost
bctraits.all$nest.type[bctraits.all$common_name=="Pacific Golden-Plover"] <- "scrape"
bctraits.all$majority.nesting.location[bctraits.all$common_name=="Pacific Golden-Plover"] <- "ground"
bctraits.all$nest.category[bctraits.all$common_name=="Pacific Golden-Plover"] <- "open"

#lots of missing data for South Polar Skua...breed in antartica, so maybe these arent helpful!
bctraits.all$ReproAge[bctraits.all$common_name=="South Polar Skua"] <- 6 
bctraits.all$clutches.per.year[bctraits.all$common_name=="South Polar Skua"] <- 1 
bctraits.all$nest.type[bctraits.all$common_name=="South Polar Skua"] <- "scrape"
bctraits.all$majority.nesting.location[bctraits.all$common_name=="South Polar Skua"] <- "ground"
bctraits.all$nest.category[bctraits.all$common_name=="South Polar Skua"] <- "open"

#Short-tailed Shearwater - breeds in Australia, summers in Berrings sea
bctraits.all$lifespan[bctraits.all$common_name=="Short-tailed Shearwater"] <- 30 
bctraits.all$ReproAge[bctraits.all$common_name=="Short-tailed Shearwater"] <- 6 
bctraits.all$clutches.per.year[bctraits.all$common_name=="Short-tailed Shearwater"] <- 1 
#bctraits.all$nest.type[bctraits.all$common_name=="Short-tailed Shearwater"] <- "scrape"
#bctraits.all$nesting.location[bctraits.all$common_name=="Short-tailed Shearwater"] <- "ground"
#bctraits.all$nest.category[bctraits.all$common_name=="Short-tailed Shearwater"] <- "open"


#lots of missing data for Pacific Wren - associated with old growth forests
bctraits.all$lifespan[bctraits.all$common_name=="Pacific Wren"] <- 4 #making it the same as the winter wren, which it was recently split from
bctraits.all$clutches.per.year[bctraits.all$common_name=="Pacific Wren"] <- 1 #can lay a replacement clutch if first is lost
bctraits.all$majority.nesting.location[bctraits.all$common_name=="Pacific Wren"] <- "?"
bctraits.all$nest.type[bctraits.all$common_name=="Pacific Wren"] <- "cavity"
bctraits.all$nest.category[bctraits.all$common_name=="Pacific Wren"] <- "cavity"
bctraits.all$Diet.5Cat[bctraits.all$common_name=="Pacific Wren"] <- "Invertebrate"



```

```{r}
#hot off the press BIRDBASE (published sept 20 2025)
birdbase <- read.csv(here("Data", "TraitDatabases", "Birdbase", "BIRDBASE.database.csv"), skip = 1)

birdbase <- birdbase %>% 
  clean_names()
birdbase <- birdbase %>% 
  rename(iucn.2024 = x2024_iucn_red_list_category, forest.use = 33, habitat.breadth = hb, diet.breadth =db, Eco.Spec.Index = esi, latin = 3, former.latin = 5, common.name = 2) %>% 
  select(1:7, iucn.2024, rr, average_mass, elevational_range, forest.use, primary_habitat, habitat.breadth, primary_diet,diet.breadth, Eco.Spec.Index)
##ESI: Ecological Specialization Index: log10 (100/[dietary breadth x habitat breadth]), with a maximum of 2 for the most specialized species that only feed on one major food group and live in one major type of habitat (e.g., forest frugivore; Sekercioglu, 2011)
#just get BC birds
birdbase.bc <- left_join(birdlist, birdbase, by = c("sci_name" = "latin"))


unmatched.i <- birdbase.bc %>%
  filter(is.na(ioc_15_1)) %>%   # replace with a col you expect after join
  select(names(birdlist))
matched_by_i<- unmatched.i %>%
  left_join(birdbase, by = c("common_name" = "common.name"))

unmatched.2 <- matched_by_i %>%
  filter(is.na(ioc_15_1)) %>%   # replace with a col you expect after join
  select(names(birdlist))
matched_by_2<- unmatched.2 %>%
  left_join(birdbase, by = c("sci_name" = "former.latin"))

birdbase.bc<- birdbase.bc %>%
  filter(!is.na(ioc_15_1)) %>%  # keep the matched ones
  bind_rows(matched_by_i) %>% 
  filter(!is.na(ioc_15_1)) %>% 
  bind_rows(matched_by_2)

birdbase.bc<- birdbase.bc %>%
  select(-c(ioc_15_1, common.name))
# 

bctraits.all <- left_join(bctraits.all, birdbase.bc)

write.csv(bctraits.all, here("Data", "cleaned", "BC_bird_traits.csv"), row.names = FALSE)

```



```{r}



#	Pink-footed Shearwater

#we figured out these problems
# ### NESTING LOCATION ONLY
# #these guys dopnt have a nesting location from dtraits because there wasnt a nesting % >50%
# #wood duck nesting location: needs mature large trees with preformed cavities
# bctraits.all$nesting.location[bctraits.all$common_name=="Wood Duck"] <- "tree"
# # 
# # #Bufflehead nesting location: use woodpacker cavities
# # bctraits.all$nesting.location[bctraits.all$common_name=="Bufflehead"] <- "tree"
# 
# #Common Goldeneye nesting location: nests in TREE and SNAG, majority in snag
# bctraits.all$nesting.location[bctraits.all$common_name=="Common Goldeneye"] <- "snag"
# 
# #Barrow's Goldeneye nesting location: nests in TREE and SNAG
# bctraits.all$nesting.location[bctraits.all$common_name=="Barrow's Goldeneye"] <- "snag"
# 
# #Common Merganser nesting location: nests in TREE and SNAG, 50% snag
# bctraits.all$nesting.location[bctraits.all$common_name=="Common Merganser"] <- "snag"
# 
# #Black-chinned Hummingbird - 50% shrub and tree, BoW says mostly tree and >2 m high. could check this
# bctraits.all$nesting.location[bctraits.all$common_name=="Black-chinned Hummingbird"] <- "tree"
# 
# #Double-crested Cormorant
# bctraits.all$nesting.location[bctraits.all$common_name=="Double-crested Cormorant"] <- "?" #only 30% ground nesting
# 
# #Brown Pelican
# bctraits.all$nesting.location[bctraits.all$common_name=="Brown Pelican"] <- "?" # cliff or tree, BoW says cliff, 50% ground in dtrait
# 
# # Western Cattle-Egret
# bctraits.all$nesting.location[bctraits.all$common_name=="Western Cattle-Egret"] <- "?" # 50% tree
# 
# #	American Barn Owl
# bctraits.all$nesting.location[bctraits.all$common_name=="American Barn Owl"] <- "?" # cliff, building , snag
# 
# #	Western Screech-Owl
# bctraits.all$nesting.location[bctraits.all$common_name=="Western Screech-Owl"] <- "?" # tree, snag, cactus
# 
# #	Great Horned Owl
# bctraits.all$nesting.location[bctraits.all$common_name=="Great Horned Owl"] <- "?" # mixed
# 
# #Northern Hawk Owl
# bctraits.all$nesting.location[bctraits.all$common_name=="Northern Hawk Owl"] <- "?" # mixed
# 
# #	Rough-legged Hawk
# bctraits.all$nesting.location[bctraits.all$common_name=="Rough-legged Hawk"] <- "?" # mixed
# 
# #	Northern Saw-whet Owl
# bctraits.all$nesting.location[bctraits.all$common_name=="Northern Saw-whet Owl"] <- "?" # mixed
# 
# #	Boreal Owl
# bctraits.all$nesting.location[bctraits.all$common_name=="Boreal Owl"] <- "?" # mixed
# 
# #	Eastern Phoebe
# bctraits.all$nesting.location[bctraits.all$common_name=="Eastern Phoebe"] <- "?" # mixed
# #	Say's Phoebe
# bctraits.all$nesting.location[bctraits.all$common_name=="Say's Phoebe"] <- "?" # mixed
# 
# #	Tropical Kingbird
# bctraits.all$nesting.location[bctraits.all$common_name =="Tropical Kingbird"] <- "?" # mixed
# #	Western Kingbird
# bctraits.all$nesting.location[bctraits.all$common_name == "Western Kingbird"] <- "?" # mixed
# #	Eastern Kingbird
# bctraits.all$nesting.location[bctraits.all$common_name == "Eastern Kingbird"] <- "tree" # mixed
# 
# #Blue-headed Vireo
# bctraits.all$nesting.location[bctraits.all$common_name == "Blue-headed Vireo"] <- "?" # mixed
# 
# #	Black-billed Magpie
# bctraits.all$nesting.location[bctraits.all$common_name == "Black-billed Magpie"] <- "?" # mixed




```


```{r}
#update spp names
# https://ecoinfor.shinyapps.io/UTaxonstandOnline/

# data(spExample)
# data(databaseExample)
# 
# library(openxlsx)
# dat1 <- read.xlsx("Birds_ITIS_database.xlsx")
# 
# res <- nameMatch(spList=birdlist, spSource=databaseExample, author = TRUE, max.distance= 1)
# head(res)
```


simplifying categories:
- nest types: simplify to broader categories (for fire: cup, scape, cavity, [bank/crevice] 
  change outside structres ie. gourd, sphere, pendant, saucer, chamber, oven, cup --> MAKE ALL THE SAME... will be similarly affected to cups. VS TREE CAVITY; rockCREVICE/crack; burrow (+/-?) ; open[no, scrape--> combined these into one category] platform[negatively affected]  (tree; burrows; crevice[look at definition]) VS exposed )
- take out lat/long
- keep Kipp distance and hand wing distance [some direction]

foraging strategy from elton tratis: assign the majoity % for each (>50%)

from Du..: see if there are any extra records for hand wing index

add in number of clutched (but not age of maturity etc)

TODO:
- make table of tratis and directions in google drive (similar to the FIRE paper)
